<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Premier League Predictions</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
      background: #f0f2f5; 
      padding: 15px; 
      max-width: 900px; 
      margin: 0 auto;
      line-height: 1.6;
    }
    h1 { color: #1a1a1a; text-align: center; margin-bottom: 10px; }
    h2 { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 8px; margin-top: 25px; }
    .box { 
      background: #fff; 
      padding: 20px; 
      border-radius: 12px; 
      margin-bottom: 20px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    input, button, select { 
      padding: 12px; 
      margin: 6px 0; 
      border-radius: 8px; 
      border: 1px solid #ddd;
      font-size: 14px;
    }
    button { 
      background: #4CAF50; 
      color: white; 
      border: none; 
      cursor: pointer;
      font-weight: 600;
    }
    button:hover { background: #45a049; }
    button.secondary { background: #f44336; }
    .match-row { 
      display: flex; 
      gap: 10px; 
      margin: 10px 0; 
      align-items: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .match-row label { min-width: 200px; font-weight: 600; }
    .match-row input { width: 70px; text-align: center; }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 15px;
    }
    th, td { 
      border: 1px solid #e0e0e0; 
      padding: 12px; 
      text-align: center; 
    }
    th { background: #4CAF50; color: white; }
    .hidden { display: none !important; }
    #userInfo { 
      margin: 15px 0; 
      padding: 12px; 
      background: #e3f2fd; 
      border-radius: 8px;
    }
    .error { color: #f44336; }
    .success { color: #4CAF50; }
    .admin-badge { 
      background: #ff9800; 
      color: white; 
      padding: 4px 12px; 
      border-radius: 20px; 
      font-size: 12px;
    }
  </style>
</head>
<body>

<h1>âš½ Premier League Predictions</h1>

<div id="authSection" class="box">
  <h2>ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
  <input id="email" type="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" style="width: 200px;">
  <input id="password" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="width: 200px;">
  <br>
  <button id="btnLogin">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
  <button id="btnRegister">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
  <button id="btnLogout" class="secondary hidden">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  <div id="userInfo"></div>
</div>

<div id="adminPanel" class="box hidden">
  <h2>ğŸ‘‘ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù <span class="admin-badge">ADMIN</span></h2>
  
  <h3>ğŸ“‹ Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ø¬ÙˆÙ„Ø©</h3>
  <input id="matchRound" type="number" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø© (Ù…Ø«Ø§Ù„: 24)">
  <div id="matchesSetup"></div>
  <button id="btnSaveMatches" class="hidden">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</button>
  
  <hr style="margin: 20px 0;">
  
  <h3>ğŸ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆÙ‚ÙÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø©</h3>
  <input id="adminRound" type="number" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©">
  <button id="btnLoadForResults">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</button>
  <div id="adminResults"></div>
  <button id="btnPostResults" class="hidden">ğŸ”’ Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ + Ù‚ÙÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
</div>

<div id="userPanel" class="box hidden">
  <h2>ğŸ‘¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙ‚Ø¹</h2>
  <input id="roundNumber" type="number" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©">
  <button id="btnLoadMatches">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</button>
  
  <div id="predictionsForm"></div>
  
  <div id="doubleMatchSection" class="hidden" style="margin-top: 15px; padding: 15px; background: #fff3e0; border-radius: 8px;">
    <label><strong>ğŸ¯ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ©:</strong></label>
    <select id="doubleMatch">
      <option value="0">Ø¨Ø¯ÙˆÙ† Ù…Ø¶Ø§Ø¹ÙØ©</option>
    </select>
  </div>
  
  <button id="btnSubmitPrediction" class="hidden" style="margin-top: 15px;">âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙ‚Ø¹</button>
</div>

<div class="box">
  <h2>ğŸ† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h2>
  <button id="btnRefreshLeaderboard">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
  <div id="leaderboardContainer"><p style="text-align: center; color: #666;">Ø§Ø¶ØºØ· "ØªØ­Ø¯ÙŠØ«"</p></div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm'

  // âœ… Ù…ÙØ§ØªÙŠØ­ Supabase
  const SUPABASE_URL = 'https://tzgetxouxfkcyvosayjq.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR6Z2V0eG91eGZrY3l2b3NheWpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzODUxNDEsImV4cCI6MjA4NTk2MTE0MX0.4rXVi9_ReBEVXPaDoFciEwSenmq4SUa-RQjEsbfP4mk';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const $ = id => document.getElementById(id);

  let currentUser = null;
  let isAdmin = false;
  let currentMatches = [];

  // Auth
  $('btnLogin').onclick = async () => {
    const { data, error } = await supabase.auth.signInWithPassword({
      email: $('email').value,
      password: $('password').value
    });
    if (error) return showError('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);
    await initUser();
  };

  $('btnRegister').onclick = async () => {
    const { data, error } = await supabase.auth.signUp({
      email: $('email').value,
      password: $('password').value
    });
    if (error) return showError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + error.message);
    showSuccess('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨!');
  };

  $('btnLogout').onclick = async () => {
    await supabase.auth.signOut();
    location.reload();
  };

  async function initUser() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      $('userInfo').innerHTML = '<span class="error">ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>';
      return;
    }

    currentUser = user;
    const { data: adminData } = await supabase.from('admins').select('*').eq('uid', user.id).single();
    isAdmin = !!adminData;

    let html = `<strong>Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.email}</strong>`;
    if (isAdmin) html += ' <span class="admin-badge">ADMIN</span>';
    $('userInfo').innerHTML = html;

    $('btnLogin').classList.add('hidden');
    $('btnRegister').classList.add('hidden');
    $('btnLogout').classList.remove('hidden');

    if (isAdmin) {
      $('adminPanel').classList.remove('hidden');
      setupAdminMatches();
    }
    $('userPanel').classList.remove('hidden');
    loadLeaderboard();
  }

  function showError(msg) { $('userInfo').innerHTML = `<span class="error">${msg}</span>`; }
  function showSuccess(msg) { $('userInfo').innerHTML = `<span class="success">${msg}</span>`; }

  // Admin: Setup Matches
  function setupAdminMatches() {
    const container = $('matchesSetup');
    container.innerHTML = '';
    for (let i = 1; i <= 10; i++) {
      const div = document.createElement('div');
      div.className = 'match-row';
      div.innerHTML = `<label>Ù…Ø¨Ø§Ø±Ø§Ø© ${i}:</label><input id="setupName${i}" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£Ù‡Ù„ÙŠ vs Ø§Ù„Ù‡Ù„Ø§Ù„" style="flex: 1;">`;
      container.appendChild(div);
    }
    $('btnSaveMatches').classList.remove('hidden');
  }

  $('btnSaveMatches').onclick = async () => {
    const roundNum = $('matchRound').value;
    if (!roundNum) return showError('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©');
    const roundId = `round_${roundNum}`;
    
    await supabase.from('rounds').upsert({ id: roundId, round_number: parseInt(roundNum), is_locked: false });
    
    const matches = [];
    for (let i = 1; i <= 10; i++) {
      const name = $(`setupName${i}`).value.trim();
      if (!name) return showError(`Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù…Ø¨Ø§Ø±Ø§Ø© ${i}`);
      matches.push({ round_id: roundId, match_index: i, name });
    }

    const { error } = await supabase.from('matches').upsert(matches, { onConflict: ['round_id', 'match_index'] });
    if (error) return showError('Ø®Ø·Ø£: ' + error.message);
    showSuccess('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª');
  };

  // Admin: Post Results
  $('btnLoadForResults').onclick = async () => {
    const roundNum = $('adminRound').value;
    if (!roundNum) return showError('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø©');
    const roundId = `round_${roundNum}`;
    
    const { data: matches, error } = await supabase.from('matches').select('*').eq('round_id', roundId).order('match_index');
    if (error || !matches.length) return showError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª');

    currentMatches = matches;
    const container = $('adminResults');
    container.innerHTML = '';
    matches.forEach(m => {
      const div = document.createElement('div');
      div.className = 'match-row';
      div.innerHTML = `<label>${m.name}</label><div><input id="res${m.match_index}h" type="number" placeholder="Ø£Ø±Ø¶ÙŠ"> - <input id="res${m.match_index}a" type="number" placeholder="Ø¶ÙŠÙ"></div>`;
      container.appendChild(div);
    });
    $('btnPostResults').classList.remove('hidden');
  };

  $('btnPostResults').onclick = async () => {
    const roundNum = $('adminRound').value;
    const roundId = `round_${roundNum}`;
    const results = { round_id: roundId };
    
    for (let i = 1; i <= 10; i++) {
      results[`match_${i}_home`] = parseInt($(`res${i}h`).value) || 0;
      results[`match_${i}_away`] = parseInt($(`res${i}a`).value) || 0;
    }

    const { error } = await supabase.from('actual_results').upsert(results, { onConflict: ['round_id'] });
    if (error) return showError('Ø®Ø·Ø£: ' + error.message);

    await supabase.from('rounds').upsert({ id: roundId, is_locked: true }, { onConflict: ['id'] });
    showSuccess('ğŸ† ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆÙ‚ÙÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø©!');
    loadLeaderboard();
  };

  // User: Predictions
  $('btnLoadMatches').onclick = async () => {
    const roundNum = $('roundNumber').value;
    const roundId = `round_${roundNum}`;
    
    const { data: round } = await supabase.from('rounds').select('is_locked').eq('id', roundId).single();
    if (round?.is_locked) return showError('âŒ Ø§Ù„Ø¬ÙˆÙ„Ø© Ù…Ù‚ÙÙ„Ø©');

    const { data: matches, error } = await supabase.from('matches').select('*').eq('round_id', roundId).order('match_index');
    if (error || !matches.length) return showError('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª');

    currentMatches = matches;
    const container = $('predictionsForm');
    container.innerHTML = '';
    const doubleSelect = $('doubleMatch');
    doubleSelect.innerHTML = '<option value="0">Ø¨Ø¯ÙˆÙ† Ù…Ø¶Ø§Ø¹ÙØ©</option>';

    matches.forEach(m => {
      const div = document.createElement('div');
      div.className = 'match-row';
      div.innerHTML = `<label>${m.name}</label><div><input id="pred${m.match_index}h" type="number" placeholder="0"> - <input id="pred${m.match_index}a" type="number" placeholder="0"></div>`;
      container.appendChild(div);
      
      const opt = document.createElement('option');
      opt.value = m.match_index;
      opt.text = m.name;
      doubleSelect.add(opt);
    });

    $('doubleMatchSection').classList.remove('hidden');
    $('btnSubmitPrediction').classList.remove('hidden');
  };

  $('btnSubmitPrediction').onclick = async () => {
    if (!currentUser) return showError('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    const roundNum = $('roundNumber').value;
    const roundId = `round_${roundNum}`;

    const prediction = {
      user_id: currentUser.id,
      participant_name: currentUser.email,
      round_id: roundId,
      double_match: parseInt($('doubleMatch').value) || 0
    };

    for (let i = 1; i <= 10; i++) {
      prediction[`match_${i}_home`] = parseInt($(`pred${i}h`).value) || 0;
      prediction[`match_${i}_away`] = parseInt($(`pred${i}a`).value) || 0;
    }

    const { error } = await supabase.from('predictions').upsert(prediction, { onConflict: ['user_id', 'round_id'] });
    if (error) return showError('Ø®Ø·Ø£: ' + error.message);
    showSuccess('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙˆÙ‚Ø¹');
  };

  // Leaderboard
  $('btnRefreshLeaderboard').onclick = loadLeaderboard;

  async function loadLeaderboard() {
    const { data, error } = await supabase.from('leaderboard').select('*').order('total_points', { ascending: false }).limit(50);
    if (error) return $('leaderboardContainer').innerHTML = '<p class="error">Ø®Ø·Ø£</p>';
    
    if (!data?.length) return $('leaderboardContainer').innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';

    let html = '<table><tr><th>Ø§Ù„Ù…Ø±ÙƒØ²</th><th>Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr>';
    data.forEach((row, index) => {
      html += `<tr><td>#${row.rank || index + 1}</td><td>${row.participant_name || 'Ù…Ø¬Ù‡ÙˆÙ„'}</td><td>${row.total_points || 0}</td></tr>`;
    });
    html += '</table>';
    $('leaderboardContainer').innerHTML = html;
  }

  supabase.auth.onAuthStateChange(() => initUser());
  initUser();
</script>

</body>
</html>
